name: Build iOS App and Release

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest

    - name: Build iOS app
      run: |
        xcodebuild -scheme "Royal-Gold" \
          -sdk iphoneos \
          -configuration Release \
          archive -archivePath build/RoyalGold.xcarchive

        xcodebuild -exportArchive \
          -archivePath build/RoyalGold.xcarchive \
          -exportPath build \
          -exportOptionsPlist ExportOptions.plist

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Royal Gold v${{ github.run_number }}
        body: "تطبيق iOS - Royal Gold (مبني تلقائيًا من GitHub Actions)"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload IPA to Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        files: build/*.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
